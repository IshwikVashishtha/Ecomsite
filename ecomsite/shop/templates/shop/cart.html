{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Shopping Cart - ModernShop{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-cart3 me-2"></i>Shopping Cart
                        <span class="badge bg-light text-primary ms-2">{{ cart_items.count }} items</span>
                    </h4>
                </div>
                <div class="card-body">
                    {% if cart_items %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                <tr class="cart-item-row" data-item-id="{{ item.id }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ item.product.image }}" alt="{{ item.product.title }}" 
                                                 class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                            <div>
                                                <h6 class="mb-1">{{ item.product.title }}</h6>
                                                <small class="text-muted">{{ item.product.category.name }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="price-info">
                                            {% if item.product.discount_price %}
                                            <span class="text-decoration-line-through text-muted">₹{{ item.product.price }}</span>
                                            <span class="fw-bold text-danger ms-2">₹{{ item.product.discount_price }}</span>
                                            {% else %}
                                            <span class="fw-bold">₹{{ item.product.price }}</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="quantity-controls">
                                            <div class="input-group" style="width: 120px;">
                                                <button class="btn btn-outline-secondary btn-sm quantity-btn" data-action="decrease">
                                                    <i class="bi bi-dash"></i>
                                                </button>
                                                <input type="number" class="form-control text-center quantity-input" 
                                                       value="{{ item.quantity }}" min="1" max="10" 
                                                       data-item-id="{{ item.id }}">
                                                <button class="btn btn-outline-secondary btn-sm quantity-btn" data-action="increase">
                                                    <i class="bi bi-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-bold item-total">₹{{ item.total_price }}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm remove-item" data-item-id="{{ item.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Cart Actions -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <a href="{% url 'index' %}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                        </a>
                        <button class="btn btn-outline-secondary" id="clear-cart">
                            <i class="bi bi-trash me-2"></i>Clear Cart
                        </button>
                    </div>
                    {% else %}
                    <!-- Empty Cart -->
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x fs-1 text-muted mb-3"></i>
                        <h4 class="text-muted">Your cart is empty</h4>
                        <p class="text-muted mb-4">Looks like you haven't added any products to your cart yet.</p>
                        <a href="{% url 'index' %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-shop me-2"></i>Start Shopping
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt me-2"></i>Order Summary
                    </h5>
                </div>
                <div class="card-body">
                    {% if cart_items %}
                    <div class="summary-item d-flex justify-content-between mb-2">
                        <span>Subtotal ({{ cart.total_items }} items)</span>
                        <span>₹{{ cart.total_price }}</span>
                    </div>
                    <div class="summary-item d-flex justify-content-between mb-2">
                        <span>Shipping</span>
                        <span class="text-success">Free</span>
                    </div>
                    <div class="summary-item d-flex justify-content-between mb-2">
                        <span>Tax</span>
                        <span>₹0.00</span>
                    </div>
                    <hr>
                    <div class="summary-item d-flex justify-content-between mb-3">
                        <strong>Total</strong>
                        <strong class="fs-5 text-primary">₹{{ cart.total_price }}</strong>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'checkout' %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-credit-card me-2"></i>Proceed to Checkout
                        </a>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="mt-3">
                        <small class="text-muted">We accept:</small>
                        <div class="d-flex gap-2 mt-2">
                            <i class="bi bi-credit-card text-primary"></i>
                            <i class="bi bi-paypal text-primary"></i>
                            <i class="bi bi-wallet2 text-primary"></i>
                        </div>
                    </div>
                    
                    <!-- Security Badge -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shield-check text-success me-2"></i>
                            <small class="text-muted">Secure checkout with SSL encryption</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-cart-x fs-1 text-muted mb-3"></i>
                        <p class="text-muted">No items in cart</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Quantity controls
    $('.quantity-btn').click(function() {
        const button = $(this);
        const input = button.siblings('.quantity-input');
        const action = button.data('action');
        let value = parseInt(input.val());
        
        if (action === 'increase' && value < 10) {
            value++;
        } else if (action === 'decrease' && value > 1) {
            value--;
        }
        
        input.val(value);
        updateCartItem(input);
    });
    
    // Quantity input change
    $('.quantity-input').change(function() {
        updateCartItem($(this));
    });
    
    // Remove item
    $('.remove-item').click(function() {
        const button = $(this);
        const itemId = button.data('item-id');
        
        if (confirm('Are you sure you want to remove this item from your cart?')) {
            $.ajax({
                url: '{% url "remove_from_cart" %}',
                method: 'POST',
                data: JSON.stringify({
                    item_id: itemId
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Remove row from table
                        $(`.cart-item-row[data-item-id="${itemId}"]`).fadeOut(300, function() {
                            $(this).remove();
                            updateCartSummary(response);
                            
                            // If no items left, reload page to show empty cart
                            if (response.cart_count === 0) {
                                location.reload();
                            }
                        });
                        
                        // Update cart count in navbar
                        $('.cart-count').text(response.cart_count);
                        
                        showAlert('Item removed from cart', 'success');
                    }
                },
                error: function() {
                    showAlert('Error removing item from cart', 'danger');
                }
            });
        }
    });
    
    // Clear cart
    $('#clear-cart').click(function() {
        if (confirm('Are you sure you want to clear your entire cart?')) {
            // Remove all items one by one
            $('.cart-item-row').each(function() {
                const itemId = $(this).data('item-id');
                $.ajax({
                    url: '{% url "remove_from_cart" %}',
                    method: 'POST',
                    data: JSON.stringify({
                        item_id: itemId
                    }),
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    }
                });
            });
            
            setTimeout(function() {
                location.reload();
            }, 500);
        }
    });
    
    function updateCartItem(input) {
        const itemId = input.data('item-id');
        const quantity = parseInt(input.val());
        
        $.ajax({
            url: '{% url "update_cart_item" %}',
            method: 'POST',
            data: JSON.stringify({
                item_id: itemId,
                quantity: quantity
            }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Update item total
                    $(`.cart-item-row[data-item-id="${itemId}"] .item-total`).text('₹' + response.item_total);
                    
                    // Update cart summary
                    updateCartSummary(response);
                    
                    // Update cart count in navbar
                    $('.cart-count').text(response.cart_count);
                    
                    showAlert('Cart updated', 'success');
                }
            },
            error: function() {
                showAlert('Error updating cart', 'danger');
            }
        });
    }
    
    function updateCartSummary(response) {
        // Update summary values (you might need to adjust based on your response structure)
        $('.summary-item:first span:last').text('₹' + response.cart_total);
        $('.summary-item:last strong:last').text('₹' + response.cart_total);
    }
    
    function showAlert(message, type) {
        const alert = $(`
            <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('body').append(alert);
        
        setTimeout(function() {
            alert.alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}
